<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.poll.service.PollMapper">
	
	<resultMap type="Poll" id="pollPlainResultMap">
		<id column="PO_ID" property="poId" javaType="Integer" />
		<result column="PO_QUESTION" property="poQuestion" javaType="String" />
		<result column="PO_DESCRIPTION" property="poDescription" javaType="String" />	
		<result column="PO_START_DATE" property="poStartDate" javaType="String" />
		<result column="PO_END_DATE" property="poEndDate" javaType="String" />
		<result column="PO_TYPE" property="poType" javaType="String" />
		<result column="PO_REGDATE" property="poRegDate" javaType="Date" />	
		<result column="PO_USE" property="poUse" javaType="Boolean" />
		<result column="PO_YES_CNT" property="poYesCnt" javaType="Integer" />
		<result column="PO_NO_CNT" property="poNoCnt" javaType="Integer" />
		<result column="PO_HIT" property="poHit" javaType="Integer" />
		<result column="PO_THUMB_TEXT" property="poThumbText" javaType="String" />
		<association column="PO_THUMB" property="thumb" javaType="FileInfo" resultMap="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoPlainResultMap" />
	</resultMap>
	
	<sql id="pollPlainColumns">
		PO_ID
		, PO_QUESTION
		, PO_DESCRIPTION
		, PO_START_DATE
		, PO_END_DATE
		, PO_TYPE
		, PO_REGDATE
		, PO_USE
		, PO_YES_CNT
		, PO_NO_CNT
		, PO_HIT
		, PO_THUMB
		, PO_THUMB_TEXT
		, SITE_PREFIX
	</sql>
	
	<sql id="pollJoinColumns">
		PO.PO_ID
		, PO.PO_QUESTION
		, PO.PO_DESCRIPTION
		, PO.PO_START_DATE
		, PO.PO_END_DATE
		, PO.PO_TYPE
		, PO.PO_REGDATE
		, PO.PO_USE
		, PO.PO_YES_CNT
		, PO.PO_NO_CNT
		, PO.PO_HIT
		, PO.PO_THUMB
		, PO.PO_THUMB_TEXT
		, PO.SITE_PREFIX
	</sql>
	
	<select id="selectPollList" parameterType="PollSearch" resultMap="pollPlainResultMap">
		<if test="paging">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM(
		</if>
			SELECT 
				<include refid="pollJoinColumns"/>
				, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
			FROM ASA_POLL PO
			LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON PO.PO_THUMB = FI.FILE_ID
			<where>
				<if test="poType != null and poType != ''">
					AND PO.PO_TYPE = #{poType}
				</if>
				<if test="poUse != null">
					AND PO.PO_USE = #{poUse}
				</if>
				<if test="sv != null and sv != ''">
					<if test="sc == null or sc == ''">
						AND (
							PO.PO_QUESTION LIKE '%'||#{sv}||'%'
							OR PO.PO_DESCRIPTION LIKE '%'||#{sv}||'%'
						)
					</if>
					<if test="sc != null and sc != ''">
						AND ${sc} LIKE '%'||#{sv}||'%'
					</if>
				</if>
				<if test="poStatus != null and poStatus != ''">
					<if test="poStatus == 'ongoing'">
						<![CDATA[
						AND #{poToday} >= NVL(PO.PO_START_DATE, '2000-01-01')
						AND #{poToday} <= NVL(PO.PO_END_DATE, '2099-01-01')
						]]>	
					</if>
					<if test="poStatus == 'complete'">
						<![CDATA[
						AND #{poToday} > NVL(PO.PO_END_DATE, '2099-01-01')
						]]>	
					</if>
				</if>
				AND SITE_PREFIX = #{sitePrefix}
			</where>
			<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
				ORDER BY ${sortOrder} ${sortDirection}
			</if>
			<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
				ORDER BY PO.PO_REGDATE DESC
			</if> 
		<if test="paging">
			) Z
		)
		<where>
			RN BETWEEN #{startRow} AND #{endRow}
		</where>
		</if>
	</select>
	
	<select id="selectPollListTotal" parameterType="PollSearch" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM ASA_POLL PO
		LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON PO.PO_THUMB = FI.FILE_ID
		<where>
			<if test="poType != null and poType != ''">
				AND PO.PO_TYPE = #{poType}
			</if>
			<if test="poUse != null">
				AND PO.PO_USE = #{poUse}
			</if>
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						PO.PO_QUESTION LIKE '%'||#{sv}||'%'
						OR PO.PO_DESCRIPTION LIKE '%'||#{sv}||'%'
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE '%'||#{sv}||'%'
				</if>
			</if>
			<if test="poStatus != null and poStatus != ''">
				<if test="poStatus == 'ongoing'">
					<![CDATA[
					AND #{poToday} >= NVL(PO.PO_START_DATE, '2000-01-01')
					AND #{poToday} <= NVL(PO.PO_END_DATE, '2099-01-01')
					]]>	
				</if>
				<if test="poStatus == 'complete'">
					<![CDATA[
					AND #{poToday} > NVL(PO.PO_END_DATE, '2099-01-01')
					]]>	
				</if>
			</if>
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</select>
	
	<select id="selectPoll" parameterType="Poll" resultMap="pollPlainResultMap">
		SELECT 
			<include refid="pollJoinColumns"/>
			, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
		FROM ASA_POLL PO
		LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON PO.PO_THUMB = FI.FILE_ID
		<where>
			PO.PO_ID = #{poId}
		</where>
	</select>
	
	<insert id="insertPoll" parameterType="Poll">
		<selectKey keyProperty="poId" order="BEFORE" resultType="Integer">
			SELECT ${sitePrefix}_POLL_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO ASA_POLL (
			<include refid="pollPlainColumns"/>
		) VALUES (
			#{poId}
			, #{poQuestion}
			, #{poDescription}
			, #{poStartDate}
			, #{poEndDate}
			, #{poType}
			, #{poRegDate}
			, #{poUse}
			, #{poYesCnt}
			, #{poNoCnt}
			, #{poHit}
			, #{thumb.fileId}
			, #{poThumbText}
			, #{sitePrefix}
		)
	</insert>
	
	<update id="updatePoll" parameterType="Poll">
		UPDATE ASA_POLL SET
			PO_QUESTION			= #{poQuestion}
			, PO_DESCRIPTION	= #{poDescription}
			, PO_START_DATE		= #{poStartDate}
			, PO_END_DATE		= #{poEndDate}
			, PO_TYPE			= #{poType}
			, PO_USE			= #{poUse}
			, PO_THUMB			= #{thumb.fileId}
			, PO_THUMB_TEXT		= #{poThumbText}
		<where>
			PO_ID = #{poId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<delete id="deletePoll" parameterType="Poll">
		DELETE FROM ASA_POLL
		<where>
			PO_ID = #{poId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</delete>
	
	<update id="updatePollYes" parameterType="Poll">
		UPDATE ASA_POLL SET
			PO_YES_CNT = PO_YES_CNT + 1
		<where>
			PO_ID = #{poId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<update id="updatePollNo" parameterType="Poll">
		UPDATE ASA_POLL SET
			PO_NO_CNT = PO_NO_CNT + 1
		<where>
			PO_ID = #{poId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<update id="updatePollHit" parameterType="Poll">
		UPDATE ASA_POLL SET
			PO_HIT = PO_HIT + 1
		<where>
			PO_ID = #{poId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
</mapper>