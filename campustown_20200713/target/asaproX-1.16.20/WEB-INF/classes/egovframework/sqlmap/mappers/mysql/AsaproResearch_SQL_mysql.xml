<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.archive.customtype.research.service.ResearchMapper">
	
	<resultMap type="Research" id="researchPlainResultMap" extends="egovframework.com.asapro.archive.service.ArchiveMapper.archivePlainResultMap">
		<result column="RES_RESEARCHER" property="resResearcher" javaType="String" />
		<result column="RES_YEAR" property="resYear" javaType="String" />	
		<result column="RES_SUPPORT" property="resSupport" javaType="String" />
		<result column="RES_SUPP_PROJECT" property="resSuppProject" javaType="String" />
	</resultMap>
	
	<resultMap type="Research" id="researchComplexResultMap" extends="egovframework.com.asapro.archive.service.ArchiveMapper.archiveComplexResultMap">
		<result column="RES_RESEARCHER" property="resResearcher" javaType="String" />
		<result column="RES_YEAR" property="resYear" javaType="String" />	
		<result column="RES_SUPPORT" property="resSupport" javaType="String" />
		<result column="RES_SUPP_PROJECT" property="resSuppProject" javaType="String" />
	</resultMap>


	<sql id="researchPlainColumns">
		ARC_ID
		, RES_RESEARCHER
		, RES_YEAR
		, RES_SUPPORT
		, RES_SUPP_PROJECT
	</sql>
			
	<sql id="researchJoinColumns">
		RES.ARC_ID AS RES_ARC_ID
		, RES.RES_RESEARCHER
		, RES.RES_YEAR
		, RES.RES_SUPPORT
		, RES.RES_SUPP_PROJECT
	</sql>
	
	
	<!-- ====================================================================================================== -->
	<!-- ==========================================		연구자료	 ================================================= -->
	<!-- ====================================================================================================== -->
	
	<select id="selectResearchList" parameterType="ResearchSearch" resultMap="researchComplexResultMap">
		SELECT
			<include refid="egovframework.com.asapro.archive.service.ArchiveMapper.archiveJoinColumns"/>
			,<include refid="researchJoinColumns" />
			, #{sitePrefix} AS SITE_PREFIX
			, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
  			, <include refid="egovframework.com.asapro.member.admin.service.AdminMemberMapper.adminMemberJoinColumns" />
		FROM 
		${sitePrefix}_ARCHIVE ARC
		RIGHT OUTER JOIN ${sitePrefix}_RESEARCH RES ON ARC.ARC_ID = RES.ARC_ID
		LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
		LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
		<where>
			ARC.ARC_CUSTOM_TYPE = 'research'
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						ARC_TITLE LIKE CONCAT('%',#{sv},'%')
						OR ARC_CONTENT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			<if test="arcCategory != null and arcCategory != ''">
				AND ARC.ARC_CATEGORY = #{arcCategory}
			</if>
			
			<if test="meta1Array != null and meta1Array != ''">
				AND
				<foreach collection="meta1Array" item="meta1" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE1 LIKE CONCAT('%',#{meta1},'%')
				</foreach>
			</if>
			<if test="meta2Array != null and meta2Array != ''">
				AND
				<foreach collection="meta2Array" item="meta2" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE2 LIKE CONCAT('%',#{meta2},'%')
				</foreach>
			</if>
			<if test="meta3Array != null and meta3Array != ''">
				AND
				<foreach collection="meta3Array" item="meta3" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE3 LIKE CONCAT('%',#{meta3},'%')
				</foreach>
			</if>
			
			
			<!-- 
			<if test="metaCode1 != null and metaCode1 != ''">
				AND ARC.ARC_META_CODE1 = #{metaCode1}
			</if>
			<if test="metaCode2 != null and metaCode2 != ''">
				AND ARC.ARC_META_CODE2 = #{metaCode2}
			</if>
			<if test="metaCode3 != null and metaCode3 != ''">
				AND ARC.ARC_META_CODE3 = #{metaCode3}
			</if>
			 -->
			 
			 <if test="resYear != null and resYear != ''">
				AND RES.RES_YEAR = #{resYear}
			</if>
			<if test="resResearcher != null and resResearcher != ''">
				AND RES.RES_RESEARCHER LIKE CONCAT('%',#{resResearcher},'%')
			</if>
			
			<if test="arcUse != null">
				AND ARC.ARC_USE = #{arcUse}
			</if>
			<if test="arcSelected1 != null">
				AND ARC.ARC_SELECTED1 = #{arcSelected1}
			</if>
		</where>
		<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
			ORDER BY ${sortOrder} ${sortDirection}
		</if>
		<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
			ORDER BY ARC.ARC_ID DESC
		</if>
		<if test="paging">
		LIMIT ${pageSize} OFFSET #{offset}
		</if>
	</select>
	
	<select id="selectResearchListTotal" parameterType="ResearchSearch" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM ${sitePrefix}_ARCHIVE ARC
		RIGHT OUTER JOIN ${sitePrefix}_RESEARCH RES ON ARC.ARC_ID = RES.ARC_ID
		LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
		LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
		<where>
			ARC.ARC_CUSTOM_TYPE = 'research'
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						ARC_TITLE LIKE CONCAT('%',#{sv},'%')
						OR ARC_CONTENT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			<if test="arcCategory != null and arcCategory != ''">
				AND ARC.ARC_CATEGORY = #{arcCategory}
			</if>
			
			<if test="meta1Array != null and meta1Array != ''">
				AND
				<foreach collection="meta1Array" item="meta1" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE1 LIKE CONCAT('%',#{meta1},'%')
				</foreach>
			</if>
			<if test="meta2Array != null and meta2Array != ''">
				AND
				<foreach collection="meta2Array" item="meta2" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE2 LIKE CONCAT('%',#{meta2},'%')
				</foreach>
			</if>
			<if test="meta3Array != null and meta3Array != ''">
				AND
				<foreach collection="meta3Array" item="meta3" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE3 LIKE CONCAT('%',#{meta3},'%')
				</foreach>
			</if>
			
			
			<!-- 
			<if test="metaCode1 != null and metaCode1 != ''">
				AND ARC.ARC_META_CODE1 = #{metaCode1}
			</if>
			<if test="metaCode2 != null and metaCode2 != ''">
				AND ARC.ARC_META_CODE2 = #{metaCode2}
			</if>
			<if test="metaCode3 != null and metaCode3 != ''">
				AND ARC.ARC_META_CODE3 = #{metaCode3}
			</if>
			 -->
			 
			 <if test="resYear != null and resYear != ''">
				AND RES.RES_YEAR = #{resYear}
			</if>
			<if test="resResearcher != null and resResearcher != ''">
				AND RES.RES_RESEARCHER LIKE CONCAT('%',#{resResearcher},'%')
			</if>
			
			<if test="arcUse != null">
				AND ARC.ARC_USE = #{arcUse}
			</if>
			<if test="arcSelected1 != null">
				AND ARC.ARC_SELECTED1 = #{arcSelected1}
			</if>
		</where>
	</select>
	
	<insert id="insertResearch" parameterType="Research">
		INSERT INTO ${sitePrefix}_RESEARCH (
			<include refid="researchPlainColumns"/>
		) VALUES (
			#{arcId}
			, #{resResearcher}
			, #{resYear}
			, #{resSupport}
			, #{resSuppProject}
		)
	</insert>
	
	<select id="selectResearch" parameterType="Research" resultMap="researchComplexResultMap">
		SELECT
			<include refid="egovframework.com.asapro.archive.service.ArchiveMapper.archiveJoinColumns"/>
			,<include refid="researchJoinColumns" />
			, #{sitePrefix} AS SITE_PREFIX
			, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
  			, <include refid="egovframework.com.asapro.member.admin.service.AdminMemberMapper.adminMemberJoinColumns" />
		FROM 
			${sitePrefix}_ARCHIVE ARC
			RIGHT OUTER JOIN ${sitePrefix}_RESEARCH RES ON ARC.ARC_ID = RES.ARC_ID
			LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
			LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
		<where>
			ARC.ARC_ID = #{arcId}
		</where>
	</select>
	
	<update id="updateResearch" parameterType="Research">
		UPDATE ${sitePrefix}_RESEARCH SET
			RES_RESEARCHER					=	#{resResearcher}
			, RES_YEAR						=	#{resYear}
			, RES_SUPPORT					=	#{resSupport}
			, RES_SUPP_PROJECT				=	#{resSuppProject}
		<where>
			ARC_ID	=	#{arcId}
		</where>
	</update>
	
</mapper>