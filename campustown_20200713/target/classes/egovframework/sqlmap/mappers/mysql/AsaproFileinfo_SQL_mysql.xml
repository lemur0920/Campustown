<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.fileinfo.service.FileInfoMapper">
	
	<resultMap type="FileInfo" id="fileInfoPlainResultMap">
		<id property="fileId" column="FILE_ID" javaType="Integer" />
		<result property="memberId" column="MEMBER_ID" javaType="String" />
		<result property="fileModule" column="FILE_MODULE" javaType="String" />
		<result property="fileModuleId" column="FILE_MODULE_ID" javaType="String" />
		<result property="fileModuleSub" column="FILE_MODULE_SUB" javaType="String" />
		<result property="fileModuleSubId" column="FILE_MODULE_SUB_ID" javaType="String" />
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME" javaType="String" />
		<result property="filePath" column="FILE_PATH" javaType="String" />
		<result property="fileThumbnailPath" column="FILE_THUMBNAIL_PATH" javaType="String" />
		<result property="fileExt" column="FILE_EXT" javaType="String" />
		<result property="fileMimeType" column="FILE_MIME_TYPE" javaType="String" />
		<result property="fileMediaType" column="FILE_MEDIA_TYPE" javaType="String" />
		<result property="fileSize" column="FILE_SIZE" javaType="Long" />
		<result property="fileRegDate" column="FILE_REGDATE" javaType="Date" />
		<result property="fileAltText" column="FILE_ALT_TEXT" javaType="String" />
		<result property="fileDownloadCount" column="FILE_DOWNLOAD_COUNT" javaType="Integer" />
		<result property="fileUUID" column="FILE_UUID" javaType="String" />
		<result property="fileOriImageWidth" column="FILE_ORI_IMAGE_WIDTH" javaType="Integer" />
		<result property="fileOriImageHeight" column="FILE_ORI_IMAGE_HEIGHT" javaType="Integer" />
		<result property="fileAttachmentType" column="FILE_ATTACHMENT_TYPE" javaType="String" />
		<result property="fileServletUrl" column="FILE_SERVLET_URL" javaType="String" />
		<result property="fileServletThumbnailUrl" column="FILE_SERVLET_THUMBNAIL_URL" javaType="String" />
	</resultMap>
	
	<sql id="fileInfoColumns">
		FILE_ID
		, MEMBER_ID
		, FILE_MODULE
		, FILE_MODULE_ID
		, FILE_MODULE_SUB
		, FILE_MODULE_SUB_ID
		, FILE_ORIGINAL_NAME
		, FILE_PATH
		, FILE_THUMBNAIL_PATH
		, FILE_EXT
		, FILE_MIME_TYPE
		, FILE_MEDIA_TYPE
		, FILE_SIZE
		, FILE_REGDATE
		, FILE_ALT_TEXT
		, FILE_DOWNLOAD_COUNT
		, FILE_UUID
		, FILE_ORI_IMAGE_WIDTH
		, FILE_ORI_IMAGE_HEIGHT
		, FILE_ATTACHMENT_TYPE
		, FILE_SERVLET_URL
		, FILE_SERVLET_THUMBNAIL_URL
	</sql>
	
	<sql id="fileInfoJoinColumns">
		FI.FILE_ID
		, FI.MEMBER_ID
		, FI.FILE_MODULE
		, FI.FILE_MODULE_ID
		, FI.FILE_MODULE_SUB
		, FI.FILE_MODULE_SUB_ID
		, FI.FILE_ORIGINAL_NAME
		, FI.FILE_PATH
		, FI.FILE_THUMBNAIL_PATH
		, FI.FILE_EXT
		, FI.FILE_MIME_TYPE
		, FI.FILE_MEDIA_TYPE
		, FI.FILE_SIZE
		, FI.FILE_REGDATE
		, FI.FILE_ALT_TEXT
		, FI.FILE_DOWNLOAD_COUNT
		, FI.FILE_UUID
		, FI.FILE_ORI_IMAGE_WIDTH
		, FI.FILE_ORI_IMAGE_HEIGHT
		, FI.FILE_ATTACHMENT_TYPE
		, FI.FILE_SERVLET_URL
		, FI.FILE_SERVLET_THUMBNAIL_URL
	</sql>
	
	<insert id="insertFileInfo" parameterType="FileInfo">
		<selectKey keyProperty="fileId" order="AFTER" resultType="Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		INSERT INTO ${sitePrefix}_FILEINFO (
			<include refid="fileInfoColumns"/>
		) VALUES (
			#{fileId}
			, #{memberId}
			, #{fileModule}
			, #{fileModuleId}
			, #{fileModuleSub}
			, #{fileModuleSubId}
			, #{fileOriginalName}
			, #{filePath}
			, #{fileThumbnailPath}
			, #{fileExt}
			, #{fileMimeType}
			, #{fileMediaType}
			, #{fileSize}
			, #{fileRegDate}
			, #{fileAltText}
			, #{fileDownloadCount}
			, #{fileUUID}
			, #{fileOriImageWidth}
			, #{fileOriImageHeight}
			, #{fileAttachmentType}
			, #{fileServletUrl}
			, #{fileServletThumbnailUrl}
		)
	</insert>
	
	<select id="selectFileInfoList" parameterType="FileInfoSearch" resultMap="fileInfoPlainResultMap">
		SELECT 
			<include refid="fileInfoColumns"/>
		FROM ${sitePrefix}_FILEINFO
		<where>
			<if test="fileModule != null and fileModule != ''">
				AND FILE_MODULE = #{fileModule}
				<if test="fileModuleId != null and fileModuleId != ''">
					AND FILE_MODULE_ID = #{fileModuleId}
				</if>
				<if test="fileModuleSub != null and fileModuleSub != ''">
					AND FILE_MODULE_SUB = #{fileModuleSub}
					<if test="fileModuleSubId != null and fileModuleSubId != ''">
						AND FILE_MODULE_SUB_ID = #{fileModuleSubId}
					</if>
				</if>
			</if>
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						FILE_ORIGINAL_NAME LIKE CONCAT('%',#{sv},'%')
						OR FILE_ALT_TEXT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			<if test="fileMediaType != null and fileMediaType != ''">
				AND FILE_MEDIA_TYPE = #{fileMediaType}
			</if>
			<if test="fileAttachmentType != null and fileAttachmentType != ''">
				AND FILE_ATTACHMENT_TYPE = #{fileAttachmentType}
			</if>
		</where>
		<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
			ORDER BY ${sortOrder} ${sortDirection}
		</if>
		<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
			ORDER BY FILE_REGDATE DESC
		</if>
		<if test="paging">
		LIMIT ${pageSize} OFFSET #{offset}
		</if>
	</select>
	
	<select id="selectFileInfoListTotal" parameterType="FileInfoSearch" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM ${sitePrefix}_FILEINFO
		<where>
			<if test="fileModule != null and fileModule != ''">
				AND FILE_MODULE = #{fileModule}
				<if test="fileModuleId != null and fileModuleId != ''">
					AND FILE_MODULE_ID = #{fileModuleId}
				</if>
				<if test="fileModuleSub != null and fileModuleSub != ''">
					AND FILE_MODULE_SUB = #{fileModuleSub}
					<if test="fileModuleSubId != null and fileModuleSubId != ''">
						AND FILE_MODULE_SUB_ID = #{fileModuleSubId}
					</if>
				</if>
			</if>
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						FILE_ORIGINAL_NAME LIKE CONCAT('%',#{sv},'%')
						OR FILE_ALT_TEXT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			<if test="fileMediaType != null and fileMediaType != ''">
				AND FILE_MEDIA_TYPE = #{fileMediaType}
			</if>
			<if test="fileAttachmentType != null and fileAttachmentType != ''">
				AND FILE_ATTACHMENT_TYPE = #{fileAttachmentType}
			</if>
		</where>
	</select>
	
	<select id="selectFileInfoListByFileIds" parameterType="Map" resultMap="fileInfoPlainResultMap">
		SELECT 
			<include refid="fileInfoColumns"/>
		FROM ${sitePrefix}_FILEINFO
		<where>
			FILE_ID IN
			<foreach collection="fileInfoList" item="item" index="index" open="(" separator="," close=")">
				#{item.fileId}
			</foreach>
		</where>
	</select>
	
	<select id="selectFileInfo" parameterType="FileInfo" resultMap="fileInfoPlainResultMap">
		SELECT 
			<include refid="fileInfoColumns"/>
		FROM ${sitePrefix}_FILEINFO
		<where>
			<if test="fileUUID != null and fileUUID != ''">
				FILE_UUID = #{fileUUID}
			</if>
			<if test="fileUUID == null or fileUUID == ''">
				AND FILE_ID = #{fileId}
			</if>
			<if test="fileAttachmentType != null and fileAttachmentType != ''">
				AND FILE_ATTACHMENT_TYPE = #{fileAttachmentType}
			</if>
		</where>
	</select>
	
	<delete id="deleteFileInfo" parameterType="FileInfo">
		DELETE FROM ${sitePrefix}_FILEINFO 
		<where>
			FILE_ID = #{fileId}
		</where>
	</delete>
	
	<update id="updateFileInfoDownloadCount" parameterType="FileInfo">
		UPDATE ${sitePrefix}_FILEINFO 
		SET FILE_DOWNLOAD_COUNT = FILE_DOWNLOAD_COUNT + 1 
		<where>
			FILE_ID = #{fileId}
		</where>
	</update>
	
	<select id="selectMediaCountMapList" parameterType="FileInfoSearch" resultType="HashMap">
		SELECT
		  FILE_MEDIA_TYPE
		  , COUNT(*) AS SUB_TOTAL
		FROM ${sitePrefix}_FILEINFO
		<where>
			FILE_MODULE = #{fileModule}
		</where>
		GROUP BY FILE_MEDIA_TYPE
	</select>
	
	<update id="updateFileInfo" parameterType="FileInfo">
		UPDATE ${sitePrefix}_FILEINFO SET
			FILE_MODULE				= #{fileModule}
			, FILE_MODULE_ID		= #{fileModuleId}
			, FILE_MODULE_SUB		= #{fileModuleSub}
			, FILE_MODULE_SUB_ID	= #{fileModuleSubId}
			, FILE_ORIGINAL_NAME	= #{fileOriginalName}
			, FILE_PATH				= #{filePath}
			, FILE_THUMBNAIL_PATH	= #{fileThumbnailPath}
			, FILE_EXT				= #{fileExt}
			, FILE_MIME_TYPE		= #{fileMimeType}
			, FILE_MEDIA_TYPE		= #{fileMediaType}
			, FILE_SIZE				= #{fileSize}
			, FILE_ALT_TEXT			= #{fileAltText}
			, FILE_ORI_IMAGE_WIDTH	= #{fileOriImageWidth}
			, FILE_ORI_IMAGE_HEIGHT	= #{fileOriImageHeight}
		<where>
			FILE_ID = #{fileId}
		</where>
	</update>
<!-- 	
	<update id="updateMedia" parameterType="Media">
		UPDATE ${sitePrefix}_FILEINFO SET
			FILE_ALT_TEXT = #{fileAltText}
		<where>
			FILE_ID = #{fileId}
		</where>
	</update>
 -->	
 
 	<update id="updateFileInfoAltText" parameterType="FileInfo">
		UPDATE ${sitePrefix}_FILEINFO SET
			FILE_ALT_TEXT = #{fileAltText}
		<where>
			FILE_ID = #{fileId}
		</where>
	</update>
</mapper>