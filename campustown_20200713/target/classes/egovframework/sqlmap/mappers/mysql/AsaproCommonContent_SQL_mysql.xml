<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.commonContent.service.CommonContentMapper">
	
	<resultMap type="CommonContent" id="commonContentPlainResultMap">
		<id property="comContId" column="COM_CONT_ID" javaType="Integer"/>
		<result property="comContModule" column="COM_CONT_MODULE" javaType="String" />
		<result property="comContModuleSub" column="COM_CONT_MODULE_SUB" javaType="String" />
		<result property="comContCate1" column="COM_CONT_CATE1" javaType="String" />
		<result property="comContCate2" column="COM_CONT_CATE2" javaType="String" />
		<result property="comContCate3" column="COM_CONT_CATE3" javaType="String" />
		<result property="comContTitle" column="COM_CONT_TITLE" javaType="String" />
		<result property="comContSubTitle" column="COM_CONT_SUB_TITLE" javaType="String" />
		<result property="comContContent" column="COM_CONT_CONTENT" javaType="String" />
		<result property="comContStatus" column="COM_CONT_STATUS" javaType="String" />
		<result property="comContRegDate" column="COM_CONT_REGDATE" javaType="Date" />
		<result property="comContModifyDate" column="COM_CONT_MODIFY_DATE" javaType="Date" />
		<result property="comContWorker.adminId" column="COM_CONT_LAST_WORKER" javaType="String" />
	</resultMap>
	
	<sql id="commonContentPlainColumns">
		COM_CONT_ID
		, COM_CONT_MODULE
		, COM_CONT_MODULE_SUB
		, COM_CONT_CATE1
		, COM_CONT_CATE2
		, COM_CONT_CATE3
		, COM_CONT_TITLE
		, COM_CONT_SUB_TITLE
		, COM_CONT_CONTENT
		, COM_CONT_STATUS
		, COM_CONT_REGDATE
		, COM_CONT_MODIFY_DATE
		, COM_CONT_LAST_WORKER
		, SITE_PREFIX
	</sql>
	
	<sql id="commonContentJoinColumns">
		CNT.COM_CONT_ID
		, CNT.COM_CONT_MODULE
		, CNT.COM_CONT_MODULE_SUB
		, CNT.COM_CONT_CATE1
		, CNT.COM_CONT_CATE2
		, CNT.COM_CONT_CATE3
		, CNT.COM_CONT_TITLE
		, CNT.COM_CONT_SUB_TITLE
		, CNT.COM_CONT_CONTENT
		, CNT.COM_CONT_STATUS
		, CNT.COM_CONT_REGDATE
		, CNT.COM_CONT_MODIFY_DATE
		, CNT.COM_CONT_LAST_WORKER
		, CNT.SITE_PREFIX
	</sql>
	
	
	<select id="selectCommonContentList" parameterType="CommonContentSearch" resultMap="commonContentPlainResultMap">
		SELECT 
			<include refid="commonContentPlainColumns"/>
		FROM ASA_COMMON_CONTENT
		<where>
			<if test="comContModule != null and comContModule != ''">
				AND COM_CONT_MODULE = #{comContModule}
			</if>
			<if test="comContModuleSub != null and comContModuleSub != ''">
				AND COM_CONT_MODULE_SUB = #{comContModuleSub}
			</if>
			<if test="cate1Array != null and cate1Array != ''">
				AND
				<foreach collection="cate1Array" item="cate1" separator="OR" open="(" close=")">
					COM_CONT_CATE1 LIKE CONCAT('%',#{cate1},'%')
				</foreach>
			</if>
			<if test="cate2Array != null and cate2Array != ''">
				AND
				<foreach collection="cate2Array" item="cate2" separator="OR" open="(" close=")">
					COM_CONT_CATE2 LIKE CONCAT('%',#{cate2},'%')
				</foreach>
			</if>
			<if test="cate3Array != null and cate3Array != ''">
				AND
				<foreach collection="cate3Array" item="cate3" separator="OR" open="(" close=")">
					COM_CONT_CATE3 LIKE CONCAT('%',#{cate3},'%')
				</foreach>
			</if>
			<if test="comContStatus != null and comContStatus != ''">
				AND COM_CONT_STATUS = #{comContStatus}
			</if>
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						COM_CONT_TITLE LIKE CONCAT('%',#{sv},'%')
						OR COM_CONT_SUB_TITLE LIKE CONCAT('%',#{sv},'%')
						OR COM_CONT_CONTENT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			AND SITE_PREFIX = #{sitePrefix}
		</where>
		<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
			ORDER BY ${sortOrder} ${sortDirection}
		</if>
		<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
			ORDER BY COM_CONT_REGDATE ASC
		</if> 
		<if test="paging">
		LIMIT ${pageSize} OFFSET #{offset}
		</if>
	</select>
	
	<select id="selectCommonContentListTotal" parameterType="CommonContentSearch" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM ASA_COMMON_CONTENT
		<where>
			<if test="comContModule != null and comContModule != ''">
				AND COM_CONT_MODULE = #{comContModule}
			</if>
			<if test="comContModuleSub != null and comContModuleSub != ''">
				AND COM_CONT_MODULE_SUB = #{comContModuleSub}
			</if>
			<if test="cate1Array != null and cate1Array != ''">
				AND
				<foreach collection="cate1Array" item="cate1" separator="OR" open="(" close=")">
					COM_CONT_CATE1 LIKE CONCAT('%',#{cate1},'%')
				</foreach>
			</if>
			<if test="cate2Array != null and cate2Array != ''">
				AND
				<foreach collection="cate2Array" item="cate2" separator="OR" open="(" close=")">
					COM_CONT_CATE2 LIKE CONCAT('%',#{cate2},'%')
				</foreach>
			</if>
			<if test="cate3Array != null and cate3Array != ''">
				AND
				<foreach collection="cate3Array" item="cate3" separator="OR" open="(" close=")">
					COM_CONT_CATE3 LIKE CONCAT('%',#{cate3},'%')
				</foreach>
			</if>
			<if test="comContStatus != null and comContStatus != ''">
				AND COM_CONT_STATUS = #{comContStatus}
			</if>
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						COM_CONT_TITLE LIKE CONCAT('%',#{sv},'%')
						OR COM_CONT_SUB_TITLE LIKE CONCAT('%',#{sv},'%')
						OR COM_CONT_CONTENT LIKE CONCAT('%',#{sv},'%')
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE CONCAT('%',#{sv},'%')
				</if>
			</if>
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</select>
	
	<insert id="insertCommonContent" parameterType="CommonContent">
		<selectKey keyProperty="comContId" order="AFTER" resultType="Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		INSERT INTO ASA_COMMON_CONTENT (
			 <include refid="commonContentPlainColumns"/>
		) VALUES (
			#{comContId}
			, #{comContModule}
			, #{comContModuleSub}
			, #{comContCate1}
			, #{comContCate2}
			, #{comContCate3}
			, #{comContTitle}
			, #{comContSubTitle}
			, #{comContContent}
			, #{comContStatus}
			, #{comContRegDate}
			, #{comContModifyDate}
			, #{comContWorker.adminId}
			, #{sitePrefix}
		)
	</insert>
	
	<select id="selectCommonContent" parameterType="CommonContent" resultMap="commonContentPlainResultMap">
		SELECT 
			<include refid="commonContentPlainColumns"/>
		FROM ASA_COMMON_CONTENT
		<where>
			COM_CONT_ID = #{comContId}
		</where>
	</select>
	
	<update id="updateCommonContent" parameterType="CommonContent">
		UPDATE ASA_COMMON_CONTENT SET
			COM_CONT_MODULE				=	#{comContModule}
			, COM_CONT_MODULE_SUB		=	#{comContModuleSub}
			, COM_CONT_CATE1			=	#{comContCate1}
			, COM_CONT_CATE2			=	#{comContCate2}
			, COM_CONT_CATE3			=	#{comContCate3}
			, COM_CONT_TITLE			=	#{comContTitle}
			, COM_CONT_SUB_TITLE		=	#{comContSubTitle}
			, COM_CONT_CONTENT			=	#{comContContent}
			, COM_CONT_STATUS			=	#{comContStatus}
			, COM_CONT_MODIFY_DATE		=	#{comContModifyDate}
			, COM_CONT_LAST_WORKER		=	#{comContWorker.adminId}
		<where>
			COM_CONT_ID		=	#{comContId}
		</where>
	</update>
		
	<delete id="deleteCommonContent" parameterType="CommonContent">
		DELETE FROM ASA_COMMON_CONTENT
		<where>
			COM_CONT_ID		=	#{comContId}
		</where>
	</delete>
	
	
	<!-- ============================================================== -->
	<!-- =====================릴레이션을 통한 공통콘텐츠 관리========================== -->
	<!-- ============================================================== -->
	
	<select id="selectCommonContentByRelation" parameterType="CommonContentRelation" resultMap="commonContentPlainResultMap">
		SELECT 
			<include refid="commonContentJoinColumns"/>
		FROM ASA_COMMON_CONTENT_REL REL
		LEFT OUTER JOIN ASA_COMMON_CONTENT CNT ON REL.COM_CONT_ID = CNT.COM_CONT_ID
		<where>
			REL.PROGRAM_ID = #{programId}
			AND REL.MODULE_CODE = #{moduleCode}
		</where>
	</select>
	
	<insert id="insertCommonContentRelation" parameterType="CommonContentRelation">
		INSERT INTO ASA_COMMON_CONTENT_REL (
			 COM_CONT_ID
			 , PROGRAM_ID
			 , MODULE_CODE
		) VALUES (
			#{comContId}
			, #{programId}
			, #{moduleCode}
		)
	</insert>
	
	<delete id="deleteCommonContentRelation" parameterType="CommonContentRelation">
		DELETE FROM ASA_COMMON_CONTENT_REL
		<where>
			PROGRAM_ID = #{programId}
			AND MODULE_CODE = #{moduleCode}
		</where>
	</delete>
	
	
</mapper>