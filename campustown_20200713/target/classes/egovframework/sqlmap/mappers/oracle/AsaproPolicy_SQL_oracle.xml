<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.archive.customtype.policy.service.PolicyMapper">
	
	<resultMap type="Policy" id="policyPlainResultMap" extends="egovframework.com.asapro.archive.service.ArchiveMapper.archivePlainResultMap">
		<result column="POLI_SHORT_DESCRIPTION" property="poliShortDescription" javaType="String" />
	</resultMap>
	
	<resultMap type="Policy" id="policyComplexResultMap" extends="egovframework.com.asapro.archive.service.ArchiveMapper.archiveComplexResultMap">
		<result column="POLI_SHORT_DESCRIPTION" property="poliShortDescription" javaType="String" />
	</resultMap>


	<sql id="policyPlainColumns">
		ARC_ID
		, POLI_SHORT_DESCRIPTION
	</sql>
			
	<sql id="policyJoinColumns">
		POLI.ARC_ID AS POLI_ARC_ID
		, POLI.POLI_SHORT_DESCRIPTION
	</sql>
	
	
	<!-- ====================================================================================================== -->
	<!-- ==========================================		정책자료	 ================================================= -->
	<!-- ====================================================================================================== -->
	
	<select id="selectPolicyList" parameterType="PolicySearch" resultMap="policyComplexResultMap">
		<if test="paging">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM(
		</if>
			SELECT
				<include refid="egovframework.com.asapro.archive.service.ArchiveMapper.archiveJoinColumns"/>
				,<include refid="policyJoinColumns" />
				, #{sitePrefix} AS SITE_PREFIX
				, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
	  			, <include refid="egovframework.com.asapro.member.admin.service.AdminMemberMapper.adminMemberJoinColumns" />
			FROM 
			${sitePrefix}_ARCHIVE ARC
			RIGHT OUTER JOIN ${sitePrefix}_POLICY POLI ON ARC.ARC_ID = POLI.ARC_ID
			LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
			LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
			<where>
				ARC.ARC_CUSTOM_TYPE = 'policy'
				<if test="sv != null and sv != ''">
					<if test="sc == null or sc == ''">
						AND (
							ARC_TITLE LIKE '%'||#{sv}||'%'
							OR ARC_CONTENT LIKE '%'||#{sv}||'%'
						)
					</if>
					<if test="sc != null and sc != ''">
						AND ${sc} LIKE '%'||#{sv}||'%'
					</if>
				</if>
				<if test="arcCategory != null and arcCategory != ''">
					AND ARC.ARC_CATEGORY = #{arcCategory}
				</if>
				
				<if test="meta1Array != null and meta1Array != ''">
					AND
					<foreach collection="meta1Array" item="meta1" separator="OR" open="(" close=")">
						ARC.ARC_META_CODE1 LIKE '%'||#{meta1}||'%'
					</foreach>
				</if>
				<if test="meta2Array != null and meta2Array != ''">
					AND
					<foreach collection="meta2Array" item="meta2" separator="OR" open="(" close=")">
						ARC.ARC_META_CODE2 LIKE '%'||#{meta2}||'%'
					</foreach>
				</if>
				<if test="meta3Array != null and meta3Array != ''">
					AND
					<foreach collection="meta3Array" item="meta3" separator="OR" open="(" close=")">
						ARC.ARC_META_CODE3 LIKE '%'||#{meta3}||'%'
					</foreach>
				</if>
				
				
				<!-- 
				<if test="metaCode1 != null and metaCode1 != ''">
					AND ARC.ARC_META_CODE1 = #{metaCode1}
				</if>
				<if test="metaCode2 != null and metaCode2 != ''">
					AND ARC.ARC_META_CODE2 = #{metaCode2}
				</if>
				<if test="metaCode3 != null and metaCode3 != ''">
					AND ARC.ARC_META_CODE3 = #{metaCode3}
				</if>
				 -->
				 
				<if test="arcUse != null">
					AND ARC.ARC_USE = #{arcUse}
				</if>
				<if test="arcSelected1 != null">
					AND ARC.ARC_SELECTED1 = #{arcSelected1}
				</if>
			</where>
			<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
				ORDER BY ${sortOrder} ${sortDirection}
			</if>
			<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
				ORDER BY ARC.ARC_ID DESC
			</if>
		<if test="paging">
			) Z
		)
		<where>
			RN BETWEEN #{startRow} AND #{endRow}
		</where>
		</if>
	</select>
	
	<select id="selectPolicyListTotal" parameterType="PolicySearch" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM ${sitePrefix}_ARCHIVE ARC
		RIGHT OUTER JOIN ${sitePrefix}_POLICY POLI ON ARC.ARC_ID = POLI.ARC_ID
		LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
		LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
		<where>
			ARC.ARC_CUSTOM_TYPE = 'policy'
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND (
						ARC_TITLE LIKE '%'||#{sv}||'%'
						OR ARC_CONTENT LIKE '%'||#{sv}||'%'
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE '%'||#{sv}||'%'
				</if>
			</if>
			<if test="arcCategory != null and arcCategory != ''">
				AND ARC.ARC_CATEGORY = #{arcCategory}
			</if>
			
			<if test="meta1Array != null and meta1Array != ''">
				AND
				<foreach collection="meta1Array" item="meta1" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE1 LIKE '%'||#{meta1}||'%'
				</foreach>
			</if>
			<if test="meta2Array != null and meta2Array != ''">
				AND
				<foreach collection="meta2Array" item="meta2" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE2 LIKE '%'||#{meta2}||'%'
				</foreach>
			</if>
			<if test="meta3Array != null and meta3Array != ''">
				AND
				<foreach collection="meta3Array" item="meta3" separator="OR" open="(" close=")">
					ARC.ARC_META_CODE3 LIKE '%'||#{meta3}||'%'
				</foreach>
			</if>
			
			
			<!-- 
			<if test="metaCode1 != null and metaCode1 != ''">
				AND ARC.ARC_META_CODE1 = #{metaCode1}
			</if>
			<if test="metaCode2 != null and metaCode2 != ''">
				AND ARC.ARC_META_CODE2 = #{metaCode2}
			</if>
			<if test="metaCode3 != null and metaCode3 != ''">
				AND ARC.ARC_META_CODE3 = #{metaCode3}
			</if>
			 -->
			 
			<if test="arcUse != null">
				AND ARC.ARC_USE = #{arcUse}
			</if>
			<if test="arcSelected1 != null">
				AND ARC.ARC_SELECTED1 = #{arcSelected1}
			</if>
		</where>
	</select>
	
	<insert id="insertPolicy" parameterType="Policy">
		INSERT INTO ${sitePrefix}_POLICY (
			<include refid="policyPlainColumns"/>
		) VALUES (
			#{arcId}
			, #{poliShortDescription}
		)
	</insert>
	
	<select id="selectPolicy" parameterType="Policy" resultMap="policyComplexResultMap">
		SELECT
			<include refid="egovframework.com.asapro.archive.service.ArchiveMapper.archiveJoinColumns"/>
			,<include refid="policyJoinColumns" />
			, #{sitePrefix} AS SITE_PREFIX
			, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
  			, <include refid="egovframework.com.asapro.member.admin.service.AdminMemberMapper.adminMemberJoinColumns" />
		FROM 
			${sitePrefix}_ARCHIVE ARC
			RIGHT OUTER JOIN ${sitePrefix}_POLICY POLI ON ARC.ARC_ID = POLI.ARC_ID
			LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
			LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
		<where>
			ARC.ARC_ID = #{arcId}
		</where>
	</select>
	
	<update id="updatePolicy" parameterType="Policy">
		UPDATE ${sitePrefix}_POLICY SET
			POLI_SHORT_DESCRIPTION					=	#{poliShortDescription}
		<where>
			ARC_ID	=	#{arcId}
		</where>
	</update>
	
	<select id="selectRecommendTermBestPolicyList" parameterType="ContentStatisSearch" resultMap="policyComplexResultMap">
		<if test="paging">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM(
		</if>	
			SELECT
				<include refid="egovframework.com.asapro.archive.service.ArchiveMapper.archiveJoinColumns"/>
				, CSD.CS_SUM_COUNT
				,<include refid="policyJoinColumns" />
				, #{sitePrefix} AS SITE_PREFIX
				, <include refid="egovframework.com.asapro.fileinfo.service.FileInfoMapper.fileInfoJoinColumns" />
	  			, <include refid="egovframework.com.asapro.member.admin.service.AdminMemberMapper.adminMemberJoinColumns" />
			FROM 
			${sitePrefix}_ARCHIVE ARC
			RIGHT OUTER JOIN ${sitePrefix}_POLICY POLI ON ARC.ARC_ID = POLI.ARC_ID
			LEFT OUTER JOIN (
				SELECT CS_CONTENT_ID, SUM(CS_COUNT) AS CS_SUM_COUNT FROM ASA_CONTENT_STATIS_DAY
				<where>
					CS_MODIUL_CODE		=	#{csModiulCode}
					<if test="csModiulSubCode != null and csModiulSubCode != ''">
						AND CS_MODIUL_SUB_CODE		=	#{csModiulSubCode}
					</if>
					<if test="csCateCode != null and csCateCode != ''">
						AND CS_CATE_CODE			=	#{csCateCode}
					</if>
					<![CDATA[
					AND CS_YEAR||'-'||LPAD(CS_MONTH, 2, '0')||'-'||LPAD(CS_DAY, 2, '0') <= #{startDate}
					AND CS_YEAR||'-'||LPAD(CS_MONTH, 2, '0')||'-'||LPAD(CS_DAY, 2, '0') >= #{endDate}
					AND SITE_PREFIX				=	#{sitePrefix}
					]]>
				</where>
				GROUP BY CS_CONTENT_ID
			) CSD ON POLI.ARC_ID = CSD.CS_CONTENT_ID
			LEFT OUTER JOIN ASA_ADMIN_MEMBER ADM ON ARC.MEM_ID = ADM.ADMIN_ID
			LEFT OUTER JOIN ${sitePrefix}_FILEINFO FI ON ARC.ARC_THUMB = FI.FILE_ID
			<where>
				ARC.ARC_CUSTOM_TYPE = 'policy'
				
				<if test="csCateCode != null and csCateCode != ''">
					AND ARC.ARC_CATEGORY = #{csCateCode}
				</if>
				AND ARC.ARC_USE = 1
			</where>
			ORDER BY CSD.CS_SUM_COUNT DESC
		<if test="paging">
			) Z
		)
		<where>
			RN BETWEEN #{startRow} AND #{endRow}
		</where>
		</if> 
	</select>
	
</mapper>