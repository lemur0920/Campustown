<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.asapro.menu.service.MenuMapper">
	
	<resultMap type="Menu" id="menuPlainResultMap">
		<id column="MENU_ID" property="menuId" javaType="String" />
		<result column="MENU_NAME" property="menuName" javaType="String" />
		<result column="MENU_TYPE" property="menuType" javaType="String" />
		<result column="MENU_GNB_TYPE" property="menuGnbType" javaType="String" />
		<result column="MENU_GNB_EXT_ON" property="menuGnbExtOn" javaType="String" />
		<result column="MENU_GNB_EXT_OFF" property="menuGnbExtOff" javaType="String" />
		<result column="MENU_SNB_TYPE" property="menuSnbType" javaType="String" />
		<result column="MENU_SNB_EXT_ON" property="menuSnbExtOn" javaType="String" />
		<result column="MENU_SNB_EXT_OFF" property="menuSnbExtOff" javaType="String" />
		<result column="MENU_TITLE_TYPE" property="menuTitleType" javaType="String" />
		<result column="MENU_TITLE_EXT" property="menuTitleExt" javaType="String" />
		<result column="MENU_TITLE_SUB_TEXT" property="menuTitleSubText" javaType="String" />
		<result column="MENU_LINK" property="menuLink" javaType="String" />
		<result column="MENU_NEW_WIN" property="menuNewWin" javaType="Boolean" />
		<result column="MENU_PARENT" property="menuParent.menuId" javaType="String" />
		<result column="MENU_DEPTH" property="menuDepth" javaType="Integer" />
		<result column="MENU_ORDER" property="menuOrder" javaType="Integer" />
		<result column="MENU_HEADER" property="menuHeader" javaType="String" />
		<result column="MENU_TEMPLATE" property="menuTemplate" javaType="String" />
		<result column="MENU_FOOTER" property="menuFooter" javaType="String" />
		<result column="MENU_STATUS" property="menuStatus" javaType="String" />
		<result column="MENU_USE_MANAGER_INFO" property="menuUseManagerInfo" javaType="Boolean" />
		<result column="MENU_MANAGER" property="menuManager" javaType="String" />
		<result column="MENU_DEPARTMENT" property="menuDepartment" javaType="String" />
		<result column="MENU_PHONE" property="menuPhone" javaType="String" />
		<result column="MENU_EMAIL" property="menuEmail" javaType="String" />
		<result column="MENU_ETC" property="menuEtc" javaType="String" />
		<result column="MENU_REGDATE" property="menuRegDate" javaType="Date" />
		<result column="MENU_LAST_MODIFIED" property="menuLastModified" javaType="Date" />
		<result column="MENU_USE_SATISFACTION" property="menuUseSatisfaction" javaType="Boolean" />
		<result column="MENU_LOCATION" property="menuLocation" javaType="String" />
		<result column="SITE_PREFIX" property="sitePrefix" javaType="String" />
		<result column="TAG_CODE" property="tagCode" javaType="String" />
	</resultMap>
	
	<!--  -->
	<resultMap type="Menu" id="menuComplexResultMap" extends="menuPlainResultMap">
		<collection column="{menuId=MENU_ID,sitePrefix=SITE_PREFIX}" property="menuChildren" javaType="ArrayList" ofType="Menu" select="selectMenuChildren" />
	</resultMap> 
	
	<sql id="menuPlainColumns">
		MENU_ID
		, MENU_NAME
		, MENU_TYPE
		, MENU_GNB_TYPE
		, MENU_GNB_EXT_ON
		, MENU_GNB_EXT_OFF
		, MENU_SNB_TYPE
		, MENU_SNB_EXT_ON
		, MENU_SNB_EXT_OFF
		, MENU_TITLE_TYPE
		, MENU_TITLE_EXT
		, MENU_TITLE_SUB_TEXT
		, MENU_LINK
		, MENU_NEW_WIN
		, MENU_PARENT
		, MENU_DEPTH
		, MENU_ORDER
		, MENU_HEADER
		, MENU_TEMPLATE
		, MENU_FOOTER
		, MENU_STATUS
		, MENU_USE_MANAGER_INFO
		, MENU_MANAGER
		, MENU_DEPARTMENT
		, MENU_PHONE
		, MENU_EMAIL
		, MENU_ETC
		, MENU_REGDATE
		, MENU_LAST_MODIFIED
		, MENU_USE_SATISFACTION
		, MENU_LOCATION
		, SITE_PREFIX
		, TAG_CODE
	</sql>
	
	<sql id="menuJoinColumns">
		MENU.MENU_ID
		, MENU.MENU_NAME
		, MENU.MENU_TYPE
		, MENU.MENU_GNB_TYPE
		, MENU.MENU_GNB_EXT_ON
		, MENU.MENU_GNB_EXT_OFF
		, MENU.MENU_SNB_TYPE
		, MENU.MENU_SNB_EXT_ON
		, MENU.MENU_SNB_EXT_OFF
		, MENU.MENU_TITLE_TYPE
		, MENU.MENU_TITLE_EXT
		, MENU.MENU_TITLE_SUB_TEXT
		, MENU.MENU_LINK
		, MENU.MENU_NEW_WIN
		, MENU.MENU_PARENT
		, MENU.MENU_DEPTH
		, MENU.MENU_ORDER
		, MENU.MENU_HEADER
		, MENU.MENU_TEMPLATE
		, MENU.MENU_FOOTER
		, MENU.MENU_STATUS
		, MENU.MENU_USE_MANAGER_INFO
		, MENU.MENU_MANAGER
		, MENU.MENU_DEPARTMENT
		, MENU.MENU_PHONE
		, MENU.MENU_EMAIL
		, MENU.MENU_ETC
		, MENU.MENU_REGDATE
		, MENU.MENU_LAST_MODIFIED
		, MENU.MENU_USE_SATISFACTION
		, MENU.MENU_LOCATION
		, MENU.SITE_PREFIX
		, MENU.TAG_CODE
	</sql>
	
	<insert id="insertMenu" parameterType="Menu">
		INSERT INTO ASA_MENU (
			<include refid="menuPlainColumns"/>
		) VALUES (
			#{menuId}
			, #{menuName}
			, #{menuType}
			, #{menuGnbType}
			, #{menuGnbExtOn}
			, #{menuGnbExtOff}
			, #{menuSnbType}
			, #{menuSnbExtOn}
			, #{menuSnbExtOff}
			, #{menuTitleType}
			, #{menuTitleExt}
			, #{menuTitleSubText}
			, #{menuLink}
			, #{menuNewWin}
			, #{menuParent.menuId}
			, #{menuDepth}
			, #{menuOrder}
			, #{menuHeader}
			, #{menuTemplate}
			, #{menuFooter}
			, #{menuStatus}
			, #{menuUseManagerInfo}
			, #{menuManager}
			, #{menuDepartment}
			, #{menuPhone}
			, #{menuEmail}
			, #{menuEtc}
			, #{menuRegDate}
			, #{menuLastModified}
			, #{menuUseSatisfaction}
			, #{menuLocation}
			, #{sitePrefix}
			, #{tagCode}
		)
	</insert>
	
	<select id="selectMenuList" parameterType="MenuSearch" resultMap="menuPlainResultMap">
		<if test="paging">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM (
		</if>
			SELECT 
				<include refid="menuPlainColumns"/>
			FROM ASA_MENU
			<where>
				<if test="menuStatus != null and menuStatus != ''">
					AND MENU_STATUS = #{menuStatus}
				</if>
				<if test="menuDepth >= 1">
					AND MENU_DEPTH = #{menuDepth}
				</if>
				AND SITE_PREFIX = #{sitePrefix}
			</where>
			ORDER BY MENU_DEPTH, MENU_ORDER
		<if test="paging">
			) Z
		)
		<where>
			RN BETWEEN #{startRow} AND #{endRow}
		</where>
		</if>
	</select>
	
	<select id="selectMenuChildren" parameterType="Menu" resultMap="menuPlainResultMap">
		SELECT 
			<include refid="menuPlainColumns"/>
		FROM ASA_MENU
		<where>
			MENU_PARENT = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where> 
		ORDER BY MENU_ORDER ASC
	</select>
		
	<select id="selectMenu" parameterType="Menu" resultMap="menuComplexResultMap">
		SELECT 
			<include refid="menuPlainColumns"/>
			<!-- , #{sitePrefix} AS SITE_PREFIX -->
		FROM ASA_MENU
		<!-- WHERE LOWER(MENU_ID) = LOWER(#{menuId}) -->
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</select>
	
	<update id="updateMenu" parameterType="Menu">
		UPDATE ASA_MENU SET
			MENU_NAME				= #{menuName}
			, MENU_TYPE				= #{menuType}
			, MENU_GNB_TYPE			= #{menuGnbType}
			, MENU_GNB_EXT_ON		= #{menuGnbExtOn}
			, MENU_GNB_EXT_OFF		= #{menuGnbExtOff}
			, MENU_SNB_TYPE			= #{menuSnbType}
			, MENU_SNB_EXT_ON		= #{menuSnbExtOn}
			, MENU_SNB_EXT_OFF		= #{menuSnbExtOff}
			, MENU_TITLE_TYPE		= #{menuTitleType}
			, MENU_TITLE_EXT		= #{menuTitleExt}
			, MENU_TITLE_SUB_TEXT	= #{menuTitleSubText}
			, MENU_LINK				= #{menuLink}
			, MENU_NEW_WIN			= #{menuNewWin}
			, MENU_PARENT			= #{menuParent.menuId}
			<!--
			, MENU_DEPTH		= #{menuDepth}
			, MENU_ORDER		= #{menuOrder}
			-->
			, MENU_HEADER			= #{menuHeader}
			, MENU_TEMPLATE			= #{menuTemplate}
			, MENU_FOOTER			= #{menuFooter}
			, MENU_STATUS			= #{menuStatus}
			, MENU_USE_MANAGER_INFO	= #{menuUseManagerInfo}
			, MENU_MANAGER			= #{menuManager}
			, MENU_DEPARTMENT		= #{menuDepartment}
			, MENU_PHONE			= #{menuPhone}
			, MENU_EMAIL			= #{menuEmail}
			, MENU_ETC				= #{menuEtc}
			, MENU_LAST_MODIFIED	= #{menuLastModified}
			, MENU_USE_SATISFACTION		= #{menuUseSatisfaction}
			, MENU_LOCATION			= #{menuLocation}
			, TAG_CODE				= #{tagCode}
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<delete id="deleteMenu" parameterType="Menu">
		DELETE FROM ASA_MENU 
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</delete>
	
	<update id="updateMenuDepth" parameterType="Menu">
		UPDATE ASA_MENU SET
			MENU_DEPTH	= #{menuDepth}
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<update id="updateMenuOrder" parameterType="Menu">
		UPDATE ASA_MENU SET
			MENU_ORDER	= #{menuOrder}
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<update id="updateMenuRebuild" parameterType="Menu">
		UPDATE ASA_MENU SET
			MENU_ORDER		= #{menuOrder}
			, MENU_DEPTH	= #{menuDepth}
			, MENU_PARENT	= #{menuParent.menuId}
		<where>
			MENU_ID = #{menuId}
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</update>
	
	<select id="findMenuByUri" parameterType="MenuSearch" resultMap="menuComplexResultMap">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM (
				SELECT 
					<include refid="menuPlainColumns"/>
					<!-- , #{sitePrefix} AS SITE_PREFIX -->
				FROM ASA_MENU
				<if test="menuLinkSearchCondition == 'equals'">
					<where>
						MENU_LINK = #{menuLink}
						AND SITE_PREFIX = #{sitePrefix}
					</where>
				</if>
				<if test="menuLinkSearchCondition == 'like'">
					<where>
						MENU_LINK LIKE #{menuLink}||'%'
						AND SITE_PREFIX = #{sitePrefix}
					</where>
				</if>
				<if test="menuLinkSearchCondition == 'likeAny'">
					<where>
						MENU_LINK LIKE '%'||#{menuLink}||'%'
						AND SITE_PREFIX = #{sitePrefix}
					</where>
				</if>
				AND MENU_TYPE != 'link'
				ORDER BY MENU_TYPE DESC
			) Z
		)
		<where>
			RN = 1
		</where>
	</select>
	
	<!-- ====================================================================================== -->
	<!-- ================================ 메뉴 검색 ======================================= -->
	<!-- ====================================================================================== -->
	<select id="selectContentMenuList" parameterType="MenuSearch" resultMap="menuPlainResultMap">
		<if test="paging">
		SELECT * FROM(
			SELECT ROWNUM RN, Z.* FROM (
		</if>
			SELECT
				<include refid="menuJoinColumns"/>
			FROM ASA_MENU MENU
			JOIN ASA_CONTENT CONT ON MENU.MENU_ID = CONT.MENU_ID  AND MENU.SITE_PREFIX = CONT.SITE_PREFIX
			<where>
				<if test="menuType != null and menuType != ''">
					AND MENU.MENU_TYPE = #{menuType}
				</if>
				
				<if test="tagCode != null and tagCode != ''">
					AND MENU.TAG_CODE like '%'||#{tagCode}||'%'
				</if>
				
				AND CONT.CONTENT_STATUS = 'publish'

				AND MENU.MENU_STATUS != 'locked'

 				AND MENU.MENU_LINK NOT LIKE '%.jsp%'
				<if test="sv != null and sv != ''">
					<if test="sc == null or sc == ''">
						AND ( 
							MENU.MENU_NAME LIKE '%'||#{sv}||'%'
							OR CONT.CONTENT_PLAIN LIKE '%'||#{sv}||'%'
						)
					</if>
					<if test="sc != null and sc != ''">
						AND ${sc} LIKE '%'||#{sv}||'%'
					</if>
				</if>
				AND SITE_PREFIX = #{sitePrefix}
			</where>	
			<if test="sortOrder != null and sortOrder != '' and sortDirection != null and sortDirection != ''">
				ORDER BY ${sortOrder} ${sortDirection}
			</if>
			<if test="sortOrder == null or sortOrder == '' or sortDirection == null or sortDirection == ''">
				ORDER BY MENU.MENU_REGDATE DESC
			</if>
		<if test="paging">
			) Z
		)
		<where>
			RN BETWEEN #{startRow} AND #{endRow}
		</where>
		</if> 
	</select>
	
	<select id="selectContentMenuListTotal" parameterType="MenuSearch" resultType="Integer">
		SELECT
			COUNT(*)
		FROM ASA_MENU MENU
		JOIN ASA_CONTENT CONT ON MENU.MENU_ID = CONT.MENU_ID  AND MENU.SITE_PREFIX = CONT.SITE_PREFIX
		<where>
			<if test="menuType != null and menuType != ''">
				AND MENU.MENU_TYPE = #{menuType}
			</if>
			
			<if test="tagCode != null and tagCode != ''">
				AND MENU.TAG_CODE like '%'||#{tagCode}||'%'
			</if>
			
			AND CONT.CONTENT_STATUS = 'publish'

			AND MENU.MENU_STATUS != 'locked'

				AND MENU.MENU_LINK NOT LIKE '%.jsp%'
			<if test="sv != null and sv != ''">
				<if test="sc == null or sc == ''">
					AND ( 
						MENU.MENU_NAME LIKE '%'||#{sv}||'%'
						OR CONT.CONTENT_PLAIN LIKE '%'||#{sv}||'%'
					)
				</if>
				<if test="sc != null and sc != ''">
					AND ${sc} LIKE '%'||#{sv}||'%'
				</if>
			</if>
			AND SITE_PREFIX = #{sitePrefix}
		</where>
	</select>
	
</mapper>